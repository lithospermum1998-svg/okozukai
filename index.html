<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>MONEY LOG</title>

<style>
:root{
  --blue:#007aff;--green:#34c759;--red:#ff3b30;
  --bg:#f2f2f7;--card:#fff;--sub:#8e8e93;--r:12px;
}
body{margin:0;padding:16px;background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;}
.container{max-width:420px;margin:auto;background:var(--card);
  border-radius:20px;padding:20px;}
h1{text-align:center;margin:0 0 10px}
.tabs{display:flex;background:#e3e3e8;border-radius:10px;padding:2px}
.tabs button{flex:1;border:none;padding:8px;border-radius:8px;
  font-weight:bold;color:var(--sub);background:none}
.tabs button.active{background:var(--blue);color:#fff}
.page{display:none}.page.active{display:block}
.summary{background:var(--bg);padding:14px;border-radius:var(--r);
  text-align:center;margin:16px 0}
input{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e5ea}
.btns{display:flex;gap:10px}
.btn{flex:1;border:none;border-radius:10px;padding:12px;
  color:#fff;font-weight:bold}
.rec{background:var(--blue)}.inv{background:var(--green)}
.stock{background:#fff;border-radius:var(--r);padding:14px;margin-bottom:12px}
.val{font-size:22px;font-weight:800;color:var(--green)}
.amount.record{color:var(--blue);font-weight:bold}
.amount.invest{color:var(--green);font-weight:bold}
</style>
</head>

<body>
<div class="container">

<h1>MONEY LOG</h1>
<div class="tabs">
  <button id="tLog" class="active" onclick="sw('log')">家計</button>
  <button id="tNisa" onclick="sw('nisa')">NISA</button>
</div>

<!-- 家計 -->
<div id="log" class="page active">
  <div class="summary">
    <div style="font-size:12px;color:var(--sub)">今月の支出合計</div>
    <div id="monthlyTotal" style="font-size:26px;font-weight:800">0 円</div>
  </div>

  <input type="date" id="dateInput">
  <input type="number" id="amountInput" placeholder="金額">
  <input type="text" id="memoInput" placeholder="メモ">

  <div class="btns">
    <button class="btn rec" onclick="addEntry('record')">記録</button>
    <button class="btn inv" onclick="addEntry('invest')">投資</button>
  </div>

  <ul id="expenseList"></ul>
</div>

<!-- NISA -->
<div id="nisa" class="page">
  <div id="stockList"></div>
  <div class="summary">
    <div style="font-size:12px;color:var(--sub)">NISA 合計評価額</div>
    <div id="nisaTotal" style="font-size:24px;font-weight:800">0 円</div>
  </div>
</div>

</div>

<script>
/* ==== URL受信（NISA専用） ==== */
const q=new URLSearchParams(location.search);
const prices={
  g:parseInt(q.get('g')),
  w:parseInt(q.get('w')),
  s:parseInt(q.get('s'))
};

/* ==== state ==== */
let state={
  expenses:JSON.parse(localStorage.getItem('expenses'))||[],
  stocks:JSON.parse(localStorage.getItem('stocks'))||[
    {name:'ブラックロック・ゴールド',price:14500,holding:0,key:'g'},
    {name:'WCM世界成長株激選',price:0,holding:0,key:'w'},
    {name:'SMT米国トレンドランキング',price:0,holding:0,key:'s'}
  ],
  view:new Date()
};

/* URL価格反映（あれば上書き） */
state.stocks.forEach(s=>{
  if(prices[s.key]) s.price=prices[s.key];
});
localStorage.setItem('stocks',JSON.stringify(state.stocks));

/* ==== ページ切替 ==== */
function sw(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  tLog.classList.toggle('active',id==='log');
  tNisa.classList.toggle('active',id==='nisa');
  if(id==='nisa') renderStocks();
}

/* ==== 家計 ==== */
function addEntry(type){
  const a=parseInt(amountInput.value);
  if(!a) return;
  state.expenses.push({
    id:Date.now(),type,amount:a,
    memo:memoInput.value,date:dateInput.value
  });
  amountInput.value="";memoInput.value="";
  save();
}
function save(){
  localStorage.setItem('expenses',JSON.stringify(state.expenses));
  renderLog();
}
function renderLog(){
  const now=state.view;
  const f=state.expenses.filter(e=>{
    const d=new Date(e.date);
    return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth();
  });
  monthlyTotal.textContent=f.reduce((s,e)=>s+e.amount,0).toLocaleString()+" 円";
  expenseList.innerHTML=f.map(e=>`
    <li>
      <div class="amount ${e.type}">¥${e.amount.toLocaleString()}</div>
      <div style="font-size:11px;color:var(--sub)">${e.date.slice(5)} ${e.memo}</div>
    </li>`).join('');
}

/* ==== NISA ==== */
function renderStocks(){
  let total=0;
  stockList.innerHTML=state.stocks.map((s,i)=>{
    const v=Math.floor(s.price*s.holding/10000);
    total+=v;
    return`
      <div class="stock">
        <div>${s.name}</div>
        <div class="val">¥${v.toLocaleString()}</div>
        <input type="number" value="${s.price}" onchange="upd(${i},'price',this.value)">
        <input type="number" value="${s.holding}" onchange="upd(${i},'holding',this.value)">
      </div>`;
  }).join('');
  nisaTotal.textContent=total.toLocaleString()+" 円";
}
function upd(i,f,v){
  state.stocks[i][f]=parseInt(v)||0;
  localStorage.setItem('stocks',JSON.stringify(state.stocks));
  renderStocks();
}

/* 初期化 */
const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
dateInput.value=d.toISOString().split('T')[0];
renderLog();
</script>
</body>
</html>
