<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>MONEY LOG PRO</title>
<style>
/* --- 省略なし：CSSはそのまま --- */
</style>
</head>

<body>
<div class="container">

  <div class="header-card">
    <h1>MONEY LOG</h1>
    <div class="header-tabs">
      <button id="tab-log" class="active" onclick="switchPage('logPage')">家計</button>
      <button id="tab-stock" onclick="switchPage('stockPage')">NISA</button>
    </div>
  </div>

  <div class="content-card">
    <div id="logPage" class="page active">
      <div class="summary">
        <div style="font-size:12px; color:var(--text-sub)">今月の支出合計</div>
        <span id="monthlyTotal">0</span><small> 円</small>
      </div>

      <input type="date" id="dateInput">
      <input type="number" id="amountInput" placeholder="金額">
      <input type="text" id="memoInput" placeholder="メモ">

      <div class="action-row">
        <button class="btn btn-record" onclick="addEntry('record')">記録</button>
        <button class="btn btn-invest" onclick="addEntry('invest')">投資</button>
      </div>

      <ul id="expenseList"></ul>
    </div>

    <div id="stockPage" class="page">
      <div id="stockList"></div>
    </div>
  </div>
</div>

<script>
let state = {
  expenses: JSON.parse(localStorage.getItem('expenses')) || [],
  stocks: JSON.parse(localStorage.getItem('stocks')) || [
    { name: "ブラックロック・ゴールド", price: 0, holding: 0 },
    { name: "WCM世界成長株激選", price: 0, holding: 0 },
    { name: "SMT米国トレンドランキング", price: 0, holding: 0 }
  ],
  currentView: new Date(),
  editingId: null
};

function switchPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('tab-log').classList.toggle('active', id==='logPage');
  document.getElementById('tab-stock').classList.toggle('active', id==='stockPage');
  if(id==='stockPage') renderStocks();
}

function renderStocks(){
  const container=document.getElementById('stockList');
  container.innerHTML=state.stocks.map((s,i)=>{
    const valuation=Math.floor(s.price*s.holding/10000);
    return `
      <div class="stock-card">
        <div class="stock-name">${s.name}</div>
        <div class="valuation">¥${valuation.toLocaleString()}</div>
        <div class="stock-inputs">
          <div>基準価額
            <input type="number" value="${s.price}" onchange="updateStock(${i},'price',this.value)">
          </div>
          <div>保有口数
            <input type="number" value="${s.holding}" onchange="updateStock(${i},'holding',this.value)">
          </div>
        </div>
      </div>`;
  }).join('');
}

function updateStock(i,f,v){
  state.stocks[i][f]=Number(v)||0;
  localStorage.setItem('stocks',JSON.stringify(state.stocks));
  renderStocks();
}

function addEntry(type){
  const amount=Number(amountInput.value);
  if(!amount) return;

  if(state.editingId){
    state.expenses=state.expenses.filter(e=>e.id!==state.editingId);
  }

  state.expenses.push({
    id: Date.now(),
    type, amount,
    memo: memoInput.value,
    date: dateInput.value
  });

  state.editingId=null;
  amountInput.value="";
  memoInput.value="";
  save();
}

function save(){
  localStorage.setItem('expenses',JSON.stringify(state.expenses));
  updateUI();
}

function updateUI(){
  const list=document.getElementById('expenseList');
  const now=state.currentView;

  const filtered=state.expenses.filter(e=>{
    const d=new Date(e.date);
    return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth();
  });

  monthlyTotal.textContent =
    filtered.reduce((s,e)=>s+e.amount,0).toLocaleString();

  list.innerHTML=filtered.map(e=>`
    <li class="swipe-item">
      <div class="swipe-delete-btn" onclick="deleteEntry(${e.id})">削除</div>
      <div class="item-content"
        ontouchstart="handleStart(event,${e.id})"
        ontouchmove="handleMove(event,this)"   <!-- ★FIX -->
        ontouchend="clearTimeout(window.ptimer)">
        <div>
          <div class="amount ${e.type}">¥${e.amount.toLocaleString()}</div>
          <div style="font-size:11px">${e.date.slice(5)} ${e.memo}</div>
        </div>
      </div>
    </li>`).join('');
}

function deleteEntry(id){
  state.expenses=state.expenses.filter(e=>e.id!==id);
  save();
}

let startX=0;
function handleStart(e,id){
  startX=e.touches[0].pageX;
  window.ptimer=setTimeout(()=>{
    const t=state.expenses.find(x=>x.id===id);
    state.editingId=id;
    amountInput.value=t.amount;
    memoInput.value=t.memo;
    dateInput.value=t.date;
  },800);
}

function handleMove(e,el){   // ★FIX
  clearTimeout(window.ptimer);
  const diff=startX-e.touches[0].pageX;
  if(diff>60) el.style.transform="translateX(-80px)";
  if(diff<-60) el.style.transform="translateX(0)";
}

dateInput.value=new Date().toISOString().split('T')[0];
updateUI();
</script>
</body>
</html>
