<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>MONEY LOG ULTIMATE</title>
<style>
:root {
  --bg-color: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e;
  --text-sub: #8e8e93; --radius: 20px; --input-border: #e5e5ea;
  --accent: #007aff; --up-color: #34c759; --down-color: #ff3b30;
}
body { font-family: -apple-system, sans-serif; background: var(--bg-color); margin: 0; padding: 12px; color: var(--text-main); }
.container { max-width: 420px; margin: 0 auto; }
.island { background: var(--card-bg); border-radius: var(--radius); padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
.header-tabs { display: flex; background: #e5e5ea; border-radius: 10px; padding: 2px; margin-bottom: 12px; }
.header-tabs button { flex: 1; padding: 8px; border: none; background: transparent; font-weight: bold; color: var(--text-sub); border-radius: 8px; cursor: pointer; }
.header-tabs button.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.valuation { font-size: 28px; font-weight: 800; text-align: center; margin: 8px 0; }
.profit-line { display: flex; gap: 10px; font-size: 11px; color: var(--text-sub); justify-content: center; margin-bottom: 4px; }
.stock-card { background: #f9f9fb; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--input-border); }
.stock-name { font-weight: bold; font-size: 13px; margin-bottom: 4px; }
.input-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 8px; }
.ios-input { width: 100%; padding: 8px; border: 1px solid var(--input-border); border-radius: 10px; background: #fff; font-size: 12px; box-sizing: border-box; }
.btn-group { display: flex; gap: 8px; }
.btn-small { font-size: 10px; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--input-border); background: #fff; cursor: pointer; font-weight: bold; }
.page { display: none; } .page.active { display: block; }
</style>
</head>
<body>

<div class="container">
  <div class="island">
    <div class="header-tabs">
      <button id="tab-log" class="active" onclick="switchPage('logPage')">HOME</button>
      <button id="tab-stock" onclick="switchPage('stockPage')">INVEST</button>
    </div>
    <div id="logPage" class="page active">
      <div id="dateLabel" style="text-align:center; font-size:12px; color:var(--text-sub);"></div>
      <div class="valuation">¥<span id="monthlyTotal">0</span></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
        <input type="number" id="amountInput" class="ios-input" placeholder="金額" style="font-size:16px;">
        <input type="text" id="memoInput" class="ios-input" placeholder="メモ">
      </div>
      <button id="recordBtn" style="width:100%; padding:14px; border-radius:14px; border:none; background:#636366; color:#fff; font-weight:700;" onclick="addEntry()">記録</button>
      <ul id="expenseList" style="list-style:none; padding:0; margin-top:16px;"></ul>
    </div>

    <div id="stockPage" class="page">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:12px; font-weight:700; color:var(--text-sub);">TOTAL ASSETS</div>
        <div class="btn-group">
          <button id="syncBtn" class="btn-small" onclick="syncPrices()">価格同期</button>
          <button class="btn-small" onclick="snapshotBaseline()" style="background:var(--text-main); color:#fff;">基準固定</button>
        </div>
      </div>
      <div class="valuation">¥<span id="stockTotal">0</span></div>
      <div id="totalSummaryLine"></div>
      <div id="lastUpdateLabel" style="text-align:center; font-size:9px; color:var(--text-sub); margin-top:4px;"></div>
    </div>
  </div>
  <div id="stockListContainer" class="page"></div>
</div>

<script>
// 日本時間（JST）を取得するヘルパー
const getJSTDate = () => {
  return new Intl.DateTimeFormat('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Tokyo' }).format(new Date()).replace(/\//g, '-');
};

let state = {
  expenses: JSON.parse(localStorage.getItem('expenses')) || [],
  stocks: JSON.parse(localStorage.getItem('stocks')) || [
    { name: "ブラックロック・ゴールド", ticker: "48311032", price: 0, holding: 0, cost: 0, baselineValuation: 0 },
    { name: "WCM世界成長株厳選", ticker: "6831121A", price: 0, holding: 0, cost: 0, baselineValuation: 0 },
    { name: "SMT米国トレンドランキング", ticker: "6431225C", price: 0, holding: 0, cost: 0, baselineValuation: 0 }
  ],
  totalBaseline: parseInt(localStorage.getItem('totalBaseline')) || 0,
  lastSyncTime: localStorage.getItem('lastSyncTime') || "未同期",
  selectedDate: getJSTDate()
};

function save() {
  localStorage.setItem('expenses', JSON.stringify(state.expenses));
  localStorage.setItem('stocks', JSON.stringify(state.stocks));
  localStorage.setItem('totalBaseline', state.totalBaseline);
  localStorage.setItem('lastSyncTime', state.lastSyncTime);
  updateUI();
}

// 1. 同期：Yahooから最新を取る（基準値は変えない）
async function syncPrices() {
  const btn = document.getElementById('syncBtn');
  btn.textContent = "同期中..."; btn.disabled = true;

  for (let i = 0; i < state.stocks.length; i++) {
    const stock = state.stocks[i];
    try {
      const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://finance.yahoo.co.jp/quote/' + stock.ticker)}`);
      const data = await res.json();
      const doc = new DOMParser().parseFromString(data.contents, 'text/html');
      const priceElem = doc.querySelector('._3S3U_u9m');
      if (priceElem) {
        state.stocks[i].price = parseFloat(priceElem.textContent.replace(/,/g, ''));
      }
    } catch (e) { console.error(stock.name + "同期失敗"); }
  }

  state.lastSyncTime = new Intl.DateTimeFormat('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Tokyo' }).format(new Date());
  save();
  renderStocks();
  btn.textContent = "価格同期"; btn.disabled = false;
}

// 2. 確定（Snapshot）：今の評価額を「前日比」の基準としてロックする
function snapshotBaseline() {
  if (!confirm("現在の値を『基準（前日比の0円地点）』として固定しますか？")) return;
  
  let currentTotal = 0;
  state.stocks.forEach((s, i) => {
    const val = Math.floor((s.price * s.holding) / 10000);
    state.stocks[i].baselineValuation = val;
    currentTotal += val;
  });
  state.totalBaseline = currentTotal;
  save();
  renderStocks();
  alert("基準値を更新しました。これ以降の変動が『前日比』として表示されます。");
}

function renderStocks() {
  const container = document.getElementById('stockListContainer');
  let currentTotal = 0, totalCostSum = 0;

  const html = state.stocks.map((s, i) => {
    const valuation = Math.floor((s.price * s.holding) / 10000);
    currentTotal += valuation; 
    totalCostSum += (s.cost || 0);
    const diffCost = valuation - (s.cost || 0);
    const diffBase = valuation - (s.baselineValuation || valuation);

    return `
      <div class="stock-card">
        <div class="stock-name">${s.name}</div>
        <div style="font-weight:800; font-size:16px;">¥${valuation.toLocaleString()}</div>
        <div class="profit-line" style="justify-content: flex-start;">
          <span>通算: ${diffCost>=0?'+':''}${diffCost.toLocaleString()}</span>
          <span style="color:${diffBase>=0?'var(--up-color)':'var(--down-color)'}; font-weight:bold;">
            基準比: ${diffBase>=0?'+':''}${diffBase.toLocaleString()}
          </span>
        </div>
        <div class="input-grid-3">
          <input class="ios-input" type="number" value="${s.price}" onchange="updateStock(${i},'price',this.value)">
          <input class="ios-input" type="number" value="${s.holding}" onchange="updateStock(${i},'holding',this.value)" placeholder="口数">
          <input class="ios-input" type="number" value="${s.cost || 0}" onchange="updateStock(${i},'cost',this.value)" placeholder="元本万">
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = `<div class="island">${html}</div>`;
  document.getElementById('stockTotal').textContent = currentTotal.toLocaleString();
  document.getElementById('lastUpdateLabel').textContent = `最終同期 (JST): ${state.lastSyncTime}`;
  
  const totalBaseDiff = currentTotal - state.totalBaseline;
  document.getElementById('totalSummaryLine').innerHTML = `
    <div class="profit-line" style="font-weight:bold; color:${totalBaseDiff>=0?'var(--up-color)':'var(--down-color)'}">
      基準比合計: ${totalBaseDiff >= 0 ? '+' : ''}${totalBaseDiff.toLocaleString()}
    </div>
  `;
}

function updateStock(i, f, v) { state.stocks[i][f] = parseFloat(v) || 0; save(); renderStocks(); }

function switchPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id === 'stockPage') {
    document.getElementById('stockListContainer').classList.add('active');
    renderStocks();
  } else {
    document.getElementById('stockListContainer').classList.remove('active');
  }
  document.getElementById('tab-log').classList.toggle('active', id==='logPage');
  document.getElementById('tab-stock').classList.toggle('active', id==='stockPage');
}

function updateUI() {
  document.getElementById('dateLabel').textContent = state.selectedDate;
  const filtered = state.expenses.filter(e => e.date.startsWith(state.selectedDate.substring(0,7)));
  document.getElementById('monthlyTotal').textContent = filtered.reduce((s,e) => s + e.amount, 0).toLocaleString();
  document.getElementById('expenseList').innerHTML = filtered.slice().reverse().map(e => `
    <li class="stock-card" style="display:flex; justify-content:space-between; margin-bottom:6px; padding:10px;">
      <div><div style="font-weight:bold;">¥${e.amount.toLocaleString()}</div><div style="font-size:10px; color:var(--text-sub);">${e.memo||''}</div></div>
      <div style="opacity:0.3" onclick="deleteEntry(${e.id})">×</div>
    </li>
  `).join('');
}

function addEntry() {
  const a = parseInt(document.getElementById('amountInput').value);
  if(a > 0) {
    state.expenses.push({ id: Date.now(), amount: a, memo: document.getElementById('memoInput').value, date: getJSTDate() });
    document.getElementById('amountInput').value = ""; document.getElementById('memoInput').value = "";
    save();
  }
}

function deleteEntry(id) { if(confirm("削除？")) { state.expenses = state.expenses.filter(i => i.id !== id); save(); } }

updateUI();
</script>
</body>
</html>
