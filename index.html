import SwiftUI

// MARK: - Data Model
struct Expense: Identifiable, Codable {
    var id = UUID()
    let title: String
    let amount: Int
    let category: String
    let date: Date
}

// MARK: - Main View
struct ContentView: View {
    // 簡易的にデータを保持（本来はSwiftDataやUserDefaults推奨）
    @State private var expenses: [Expense] = [
        Expense(title: "ランチ", amount: 1200, category: "食費", date: Date()),
        Expense(title: "電車代", amount: 450, category: "交通費", date: Date())
    ]
    @State private var isShowingAddView = false

    // 合計金額の計算
    var totalAmount: Int {
        expenses.reduce(0) { $0 + $1.amount }
    }

    var body: some View {
        NavigationStack {
            ZStack(alignment: .bottomTrailing) {
                List {
                    // 合計金額表示セクション
                    Section {
                        HStack {
                            Text("今月の合計支出")
                                .font(.subheadline)
                                .foregroundColor(.secondary)
                            Spacer()
                            Text("¥\(totalAmount)")
                                .font(.title2)
                                .bold()
                                .foregroundColor(.primary)
                        }
                        .padding(.vertical, 8)
                    }

                    // 履歴表示セクション
                    Section(header: Text("支出履歴")) {
                        if expenses.isEmpty {
                            Text("記録がありません")
                                .foregroundColor(.secondary)
                        } else {
                            ForEach(expenses) { expense in
                                HStack(spacing: 15) {
                                    // カテゴリに応じたアイコン（簡易版）
                                    Image(systemName: categoryIcon(for: expense.category))
                                        .foregroundColor(.white)
                                        .frame(width: 32, height: 32)
                                        .background(Color.blue.gradient)
                                        .cornerRadius(8)
                                    
                                    VStack(alignment: .leading) {
                                        Text(expense.title)
                                            .font(.body)
                                        Text(expense.date.formatted(date: .abbreviated, time: .omitted))
                                            .font(.caption2)
                                            .foregroundColor(.secondary)
                                    }
                                    Spacer()
                                    Text("¥\(expense.amount)")
                                        .font(.system(.body, design: .rounded))
                                        .fontWeight(.semibold)
                                }
                                .padding(.vertical, 4)
                            }
                            .onDelete(perform: deleteExpense)
                        }
                    }
                }
                .navigationTitle("お小遣い帳")
                
                // iOS風のフローティング追加ボタン
                Button(action: { isShowingAddView = true }) {
                    Image(systemName: "plus")
                        .font(.title.bold())
                        .foregroundColor(.white)
                        .frame(width: 60, height: 60)
                        .background(Color.blue.shadow(.drop(radius: 4, x: 0, y: 4)))
                        .clipShape(Circle())
                }
                .padding(.trailing, 25)
                .padding(.bottom, 20)
            }
            .sheet(isPresented: &isShowingAddView) {
                AddExpenseView { newExpense in
                    expenses.insert(newExpense, at: 0)
                }
            }
        }
    }

    func deleteExpense(at offsets: IndexSet) {
        expenses.remove(atOffsets: offsets)
    }

    func categoryIcon(for category: String) -> String {
        switch category {
        case "食費": return "fork.knife"
        case "交通費": return "bus"
        case "娯楽": return "gamecontroller"
        default: return "bag"
        }
    }
}

// MARK: - Add Expense View
struct AddExpenseView: View {
    @Environment(\.dismiss) var dismiss
    @State private var title = ""
    @State private var amount = ""
    @State private var category = "食費"
    
    let categories = ["食費", "日用品", "娯楽", "交通費", "その他"]
    var onSave: (Expense) -> Void

    var body: some View {
        NavigationStack {
            Form {
                Section(header: Text("内容")) {
                    TextField("項目名（例：ビール）", text: &title)
                    TextField("金額", text: &amount)
                        .keyboardType(.numberPad)
                }
                
                Section(header: Text("分類")) {
                    Picker("カテゴリ", selection: &category) {
                        ForEach(categories, id: \.self) { cat in
                            Text(cat)
                        }
                    }
                    .pickerStyle(.navigationLink)
                }
            }
            .navigationTitle("新規支出")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("キャンセル") { dismiss() }
                }
                ToolbarItem(placement: .confirmationAction) {
                    Button("追加") {
                        if let amountInt = Int(amount), !title.isEmpty {
                            let new = Expense(title: title, amount: amountInt, category: category, date: Date())
                            onSave(new)
                            dismiss()
                        }
                    }
                    .disabled(title.isEmpty || amount.isEmpty)
                }
            }
        }
    }
}

// MARK: - Preview
#Preview {
    ContentView()
}
